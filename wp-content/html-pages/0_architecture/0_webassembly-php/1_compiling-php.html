<h1>Compiling PHP</h1>

<!-- wp:paragraph -->
<p>The build pipeline lives in a <a href="https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/Dockerfile"><code>Dockerfile</code></a>. In broad strokes, it:</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>This is a cool test change from the tech introduction</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":44,"sizeSlug":"full","linkDestination":"none"} -->
<figure class="wp-block-image size-full"><img src="https://playground.internal/wp-content/uploads/2024/04/44_CleanShot-2024-04-29-at-17.53.09@2x.png" alt="" class="wp-image-44"/></figure>
<!-- /wp:image -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Installs all the necessary linux packages (like <code>build-essential</code>)</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Downloads PHP and the required libraries, e.g. <code>sqlite3</code>.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Applies a few patches.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Compiles everything using <a href="https://emscripten.org/">Emscripten</a>, a drop-in replacement for the C compiler.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Compiles <code>php_wasm.c</code> – a convenient API for JavaScript.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Outputs a <code>php.wasm</code> file and one or more JavaScript loaders, depending on the configuration.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Transforms the Emscripten's default <code>php.js</code> output into an ESM module with additional features.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>To find out more about each step, refer directly to the <a href="https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/Dockerfile">Dockerfile</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading">Building</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>To build all PHP versions, run <code>npm run recompile:php:web</code> (or <code>php-wasm-node</code>) in the repository root. You'll find the output files in <code>packages/php-wasm/php-web/public</code>. To build a specific version, run <code>npm run recompile:php:web:kitchen-sink:8.0</code> or <code>npm run recompile:php:web:light:8.0</code> – depending on the build pack.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>The build produces two files: <code>php.wasm</code> and <code>php.js</code>.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading">PHP.wasm WebAssembly module</h3>
<!-- /wp:heading -->

<!-- wp:heading {"level":4} -->
<h4 class="wp-block-heading">PHP extensions</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>PHP is built with several extensions listed in the <a href="https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/Dockerfile"><code>Dockerfile</code></a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Some extensions, like <code>zip</code>, can be turned on or off during the build. Others, like <code>sqlite3</code>, are hardcoded.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>If you need to turn off one of the hardcoded extensions, feel free to open an issue in this repo. Better yet, this project needs contributors. You are more than welcome to open a PR and author the change you need.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 class="wp-block-heading">C API exposed to JavaScript</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>The C API exposed to JavaScript lives in the <a href="https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/build-assets/php_wasm.c"><code>php_wasm.c</code></a> file.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Refer to the source code and the inline documentation in <a href="https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/build-assets/php_wasm.c"><code>php_wasm.c</code></a> to learn more.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 class="wp-block-heading">Build configuration</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>The build is configurable via the <a href="https://docs.docker.com/engine/reference/commandline/build/#set-build-time-variables---build-arg">Docker <code>--build-arg</code> feature</a>. You can set them up through the <code>build.js</code> script, just run this command to get the usage message:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>npm run recompile:php:web</code></pre>
<!-- /wp:code -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading">PHP.js JavaScript module</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>The <code>php.js</code> file generated by the <a href="./03-wasm-php-compiling.md">WebAssembly PHP build pipeline</a> is <strong>not</strong> a vanilla Emscripten module. Instead, it's an ESM module that wraps the regular Emscripten output and adds some extra functionality.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Here's the API it exposes:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>// php.wasm size in bytes:
export const dependenciesTotalSize = 5644199;

// php.wasm filename:
export const dependencyFilename = 'php.wasm';

// Run Emscripten's generated module:
export default function (jsEnv, emscriptenModuleArgs) {}</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>The generated JavaScript module is not meant for direct use. Instead, it can be consumed through a <code>NodePHP</code> class in Node.js and a <code>WebPHP</code> class in the browser:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>// In Node.js:
const php = NodePHP.load('7.4');

// On the web:
const php = await WebPHP.load('8.0');</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>Both of these classes extend the <code>BasePHP</code> class exposed by the <code>@php-wasm/universal</code> package and implement the <code>UniversalPHP</code> interface that standardizes the API across all PHP environments.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading">Loading the PHP runtime</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>The load() method handles the entire PHP initialization pipeline. In particular, it:</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Instantiates the Emscripten PHP module</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Wires it together with the data dependencies and loads them</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Ensures is all happens in a correct order</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Waits until the entire loading sequence is finished</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<p><!-- --></p>